# Creating Channels and Hooks

**Channels and Hooks are the core building blocks of the Comments Protocol.**

- A **Channel** lets you build your own community on the Comments Protocol.
  Since each channel is actually an NFT, it can be owned, transferred, or traded.
  You can also set a **Hook** on a channel to define the rules for commenting on it.

- **Hooks** are smart contracts that can be set on a channel. A **Hook** defines the rules for commenting on the specified **Channel**. They unlock flexible and powerful behaviors, such as:

  1. Defining who can comment and how comments behave
  1. Charging a small fee to post a comment
  1. Integrating with other protocols, such as tokens or NFTs

Together, they create a flexible system for building on-chain communities with customizable rules.

## Getting Started

You can create channels and hooks using our [TypeScript SDK](/sdk-reference) or by interacting with our [smart contracts](/contracts).

For full code examples used in this guide, check out the [examples](https://github.com/ecp-eth/comments-monorepo/tree/main/examples/channels-and-hooks).

## TypeScript Examples

### Creating a Channel

Import the necessary functions from the `@ecp.eth/sdk` package:

```typescript
import {
  createChannel,
  getChannelCreationFee,
} from "@ecp.eth/sdk/channel-manager";
...
import { privateKeyToAccount } from "viem/accounts";
```

Initialize the account using `viem`. Ensure the account has enough balance to cover the channel creation fee:

```typescript
const account = privateKeyToAccount(privateKey);
```

Creating a channel requires paying a fee. The code below retrieves the channel creation fee and
calls the `createChannel` function from the SDK to create a new channel:

```typescript
const { fee } = await getChannelCreationFee({
  readContract: publicClient.readContract,
});
const { txHash } = await createChannel({
  name: "Ethereum Comments Protocol Updates",
  description:
    "Latest updates and announcements from the Ethereum Comments Protocol",
  metadata: JSON.stringify({
    category: "blog",
    rules: ["Be respectful", "No spam"],
  }),
  hook: "0x0000000000000000000000000000000000000000", // No hook initially
  fee: fee,
  writeContract: walletClient.writeContract,
});
```

#### Retrieve the Channel ID from Event Logs

Due to EVM limitations, return values from state-changing (write) contract calls are not propagated to off-chain callers.

To get the channel ID, you will need to loop through the events in the block where the transaction was mined.

```typescript
const events = await publicClient.getContractEvents({
  address: CHANNEL_MANAGER_ADDRESS,
  abi: ChannelManagerABI,
  eventName: "ChannelCreated",
  // Search for the event in the block where the transaction was mined
  fromBlock: receipt.blockNumber,
  toBlock: receipt.blockNumber,
});

let channelId: bigint | undefined;

for (const event of events) {
  if (
    event.eventName === "ChannelCreated" &&
    event.transactionHash === txHash
  ) {
    channelId = event.args.channelId;

    return;
  }
}

if (!channelId) {
  throw new Error("Channel id not found");
}

console.log("Channel created, id:", channelId);
```

- See the full example [here](https://github.com/ecp-eth/comments-monorepo/tree/main/examples/channels-and-hooks/typescript/create-channel.ts).
- For more details about the SDK functionality, check out our [SDK Reference](/sdk-reference).

## Solidity Examples

### Creating a Channel

First, retrieve the current channel creation fee:

```solidity
uint256 fee = channelManager.getChannelCreationFee();
```

Then create the channel and pass the fee:

```solidity
uint256 channelId = channelManager.createChannel{value: fee}(
    "My Channel",
    "Description",
    "{}",
    address(0)
);
```

- See the full example [here](https://github.com/ecp-eth/comments-monorepo/tree/main/examples/channels-and-hooks/solidity/CreateChannel.s.sol).

### Modifying the Hook on a Channel

```solidity
channelManager.setHook(channelId, hookAddress);
```

## Writing Your Own Hooks

Hooks allow you to customize channel behavior. To create a custom hook:

1. Inherit from `BaseHook`
2. Override the desired hook functions
3. Implement the required permissions

For all available hook functions, see:

- [IHook](/protocol-reference/interfaces/IHook)
- [BaseHook](/protocol-reference/hooks/BaseHook)

### Basic Hook Implementation

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import { BaseHook } from "./BaseHook.sol";
import { Hooks } from "../libraries/Hooks.sol";
import { Comments } from "../libraries/Comments.sol";
import { Channels } from "../libraries/Channels.sol";

contract MyCustomHook is BaseHook {
  function _getHookPermissions()
    internal
    pure
    override
    returns (Hooks.Permissions memory)
  {
    return
      Hooks.Permissions({
        onInitialized: true, // Enable channel initialization hook
        onCommentAdded: true, // Enable comment addition hook
        onCommentEdited: false, // Disable comment editing hook
        onCommentDeleted: false, // Disable comment deletion hook
        onChannelUpdated: false // Disable channel update hook
      });
  }

  function _onInitialized(
    address channel,
    Channels.Channel memory channelData,
    uint256 channelId
  ) internal override returns (bool) {
    // Your initialization logic here
    return true;
  }

  function _onCommentAdded(
    Comments.Comment calldata commentData,
    address msgSender,
    bytes32 commentId
  ) internal override returns (string memory) {
    // Your comment addition logic here
    return "";
  }
}
```

## Best Practices

1. **Hook Implementation**

   - Keep hook logic gas-efficient
   - Handle errors gracefully
   - Validate inputs thoroughly

2. **Channel Management**

   - Use meaningful channel names and descriptions
   - Keep track of channel IDs

3. **Security**

   - Validate all inputs in hooks
   - Be cautious with external calls
   - Consider reentrancy risks
   - Test hooks thoroughly

## Example: Token Creator Hook

Here's an example of a hook that restricts top-level comments to token creators:

```solidity
contract TokenCreatorHook is BaseHook {
  struct TokenInfo {
    address tokenAddress;
    address tokenCreator;
    uint256 tokenChainId;
  }

  mapping(uint256 => TokenInfo) private _channelTokenInfo;

  function _getHookPermissions()
    internal
    pure
    override
    returns (Hooks.Permissions memory)
  {
    return
      Hooks.Permissions({
        onInitialized: true,
        onCommentAdded: true,
        onCommentEdited: false,
        onCommentDeleted: false,
        onChannelUpdated: false
      });
  }

  function _onInitialized(
    address,
    Channels.Channel memory channel,
    uint256 channelId
  ) internal override returns (bool) {
    // Parse metadata to get token info
    // Store token info
    return true;
  }

  function _onCommentAdded(
    Comments.Comment calldata commentData,
    address,
    bytes32
  ) internal view override returns (string memory) {
    // Check if commenter is token creator
    // Validate token reference
    return "";
  }
}
```

## Troubleshooting

1. **Hook Not Working**

   - Check if hook permissions are set correctly
   - Verify the hook implementation
   - Ensure the hook is properly set on the channel
   - Remember that hooks are called after modifying contract state, and any revert in a hook will revert the entire transaction

2. **Channel Creation Fails**

   - Ensure you have enough ETH for the creation fee
   - Check if the channel name/description is valid
   - Verify that metadata is valid JSON
   - Verify the hook is approved by the ECP team

3. **Hook Reverts**

   - Check the hook implementation for errors
   - Verify input validation
   - Check gas limits

## Links

- [Protocol Reference](/protocol-reference)
- [SDK Reference](/sdk-reference)
- [Protocol Source Code](https://github.com/ecp-eth/comments-monorepo/tree/main/packages/protocol)
- [Examples](https://github.com/ecp-eth/comments-monorepo/tree/main/examples/channels-and-hooks)
