# Creating Channels and Hooks

**Channels and Hooks are the core building blocks of the Comments Protocol.**

- A **Channel** lets you build your own community on the Comments Protocol, and since each channel is actually an NFT,
  you can even sell it on an NFT marketplace if you really want to (in case you decided to retire early).
  You can also set a **Hook** on a channel to define the rules of commenting on the channel.

- **Hooks** are smart contracts that can be set on a channel, **Hook** defines the rules of commenting on the specified **Channel**. They unlock flexible and powerful behaviors, such as:

  1. Defining who can comment and how comments behave
  1. Charging a small fee to post a comment
  1. Integrating with other protocols, such as tokens or NFTs

Together, they create a flexible system for building on-chain communities with customizable rules.

## Getting Started

You can create channels and hooks using our [TypeScript SDK](/sdk-reference) or by interacting with our [smart contracts](/contracts).

For full examples of the code used in this guide, check out the [examples](https://github.com/ecp-eth/comments-monorepo/tree/main/examples/channels-and-hooks).

## TypeScript Examples

### Creating a Channel

Import the necessary functions from the `@ecp.eth/sdk` package:

```typescript
import {
  createChannel,
  getChannelCreationFee,
} from "@ecp.eth/sdk/channel-manager";
...
import { privateKeyToAccount } from "viem/accounts";
```

Initialize account using `viem`, ensure the account has enough balance to pay for the channel creation fee

```typescript
const account = privateKeyToAccount(privateKey);
```

Creating a channel requires paying a fee, the code below retrieves the channel creation fee and
calls the `createChannel` function from the SDK to create a new channel:

```typescript
const { fee } = await getChannelCreationFee({
  readContract: publicClient.readContract,
});
const { txHash } = await createChannel({
  name: "Ethereum Comments Protocol Updates",
  description:
    "Latest updates and announcements from the Ethereum Comments Protocol",
  metadata: JSON.stringify({
    category: "blog",
    rules: ["Be respectful", "No spam"],
  }),
  hook: "0x0000000000000000000000000000000000000000", // No hook initially
  fee: fee,
  writeContract: walletClient.writeContract,
});
```

#### Retrieve the Channel Id from event logs

Due to EVM limitations, return values from state-changing (write) contract calls are not propagated to off-chain callers.

To get the channel id, you will need to loop through the events within the block that the transaction was mined in.

```typescript
const events = await publicClient.getContractEvents({
  address: CHANNEL_MANAGER_ADDRESS,
  abi: ChannelManagerABI,
  eventName: "ChannelCreated",
  // search for the event in the block that the transaction was mined in
  fromBlock: receipt.blockNumber,
  toBlock: receipt.blockNumber,
});

for (const event of events) {
  if (
    event.eventName === "ChannelCreated" &&
    event.transactionHash === txHash
  ) {
    console.log("Channel created, id:", event.args.channelId);
    return;
  }
}
```

- See full example [here](https://github.com/ecp-eth/comments-monorepo/tree/main/examples/channels-and-hooks/typescript/create-channel.ts)
- For more details about the SDK functionality, check out our [SDK Reference](/sdk-reference).

## Solidity Examples

### Creating a Channel

First, retrieve current channel creation fee:

```solidity
uint256 fee = channelManager.getChannelCreationFee();
```

Then create the channel and pass the fee:

```solidity
uint256 channelId = channelManager.createChannel{value: fee}(
    "My Channel",
    "Description",
    "{}",
    address(0)
);
```

- See full example [here](https://github.com/ecp-eth/comments-monorepo/tree/main/examples/channels-and-hooks/solidity/CreateChannel.s.sol)

### Modifying the Hook on a Channel

```solidity
channelManager.setHook(channelId, hookAddress);
```

## Writing your own Hooks

Hooks allow you to customize channel behavior. To create a custom hook:

1. Inherit from `BaseHook`
2. Override the desired hook functions
3. Implement the required permissions

For all available hook functions, see:

- [IHook](/protocol-reference/interfaces/IHook)
- [BaseHook](/protocol-reference/interfaces/BaseHook).

### Basic Hook Implementation

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import { BaseHook } from "./BaseHook.sol";
import { Hooks } from "../libraries/Hooks.sol";
import { Comments } from "../libraries/Comments.sol";
import { Channels } from "../libraries/Channels.sol";

contract MyCustomHook is BaseHook {
  function _getHookPermissions()
    internal
    pure
    override
    returns (Hooks.Permissions memory)
  {
    return
      Hooks.Permissions({
        onInitialized: true, // Enable channel initialization hook
        onCommentAdded: true, // Enable comment addition hook
        onCommentEdited: false, // Disable comment editing hook
        onCommentDeleted: false, // Disable comment deletion hook
        onChannelUpdated: false // Disable channel update hook
      });
  }

  function _onInitialized(
    address channel,
    Channels.Channel memory channelData,
    uint256 channelId
  ) internal override returns (bool) {
    // Your initialization logic here
    return true;
  }

  function _onCommentAdded(
    Comments.Comment calldata commentData,
    address msgSender,
    bytes32 commentId
  ) internal override returns (string memory) {
    // Your comment addition logic here
    return "";
  }
}
```

## Best Practices

1. **Hook Implementation**

   - Keep hook logic gas-efficient
   - Handle errors gracefully
   - Validate inputs thoroughly

2. **Channel Management**

   - Use meaningful channel names and descriptions
   - Keep track of channel IDs

3. **Security**

   - Validate all inputs in hooks
   - Be careful with external calls
   - Consider reentrancy risks
   - Test hooks thoroughly

## Example: Token Creator Hook

Here's an example of a hook that restricts top-level comments to token creators:

```solidity
contract TokenCreatorHook is BaseHook {
  struct TokenInfo {
    address tokenAddress;
    address tokenCreator;
    uint256 tokenChainId;
  }

  mapping(uint256 => TokenInfo) private _channelTokenInfo;

  function _getHookPermissions()
    internal
    pure
    override
    returns (Hooks.Permissions memory)
  {
    return
      Hooks.Permissions({
        onInitialized: true,
        onCommentAdded: true,
        onCommentEdited: false,
        onCommentDeleted: false,
        onChannelUpdated: false
      });
  }

  function _onInitialized(
    address,
    Channels.Channel memory channel,
    uint256 channelId
  ) internal override returns (bool) {
    // Parse metadata to get token info
    // Store token info
    return true;
  }

  function _onCommentAdded(
    Comments.Comment calldata commentData,
    address,
    bytes32
  ) internal view override returns (string memory) {
    // Check if commenter is token creator
    // Validate token reference
    return "";
  }
}
```

## Troubleshooting

1. **Hook Not Working**

   - Check if hook permissions are set correctly
   - Verify hook implementation
   - Check if hook is properly set on channel
   - Hooks are called after modifying the contract state, and that any revert from a hook will revert the whole transaction

1. **Channel Creation Fails**

   - Ensure you have enough ETH for the creation fee
   - Check if channel name/description is valid
   - Verify metadata is valid JSON
   - Verify the hook is approved by ECP team

1. **Hook Reverts**
   - Check hook implementation for errors
   - Verify input validation
   - Check gas limits

## Links

- [Protocol Reference](/protocol-reference)
- [SDK Reference](/sdk-reference)
- [Protocol Source Code](https://github.com/ecp-eth/comments-monorepo/tree/main/packages/protocol)
- [Examples](https://github.com/ecp-eth/comments-monorepo/tree/main/examples/channels-and-hooks)
