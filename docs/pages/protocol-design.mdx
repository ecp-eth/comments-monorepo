# Protocol Design

## Smart Contract Architecture

The protocol is built on a decentralized commenting system that enables users to post and manage comments with optional app-signer approval.

### Core Contract: CommentsV1

The main contract implements EIP-712 for typed structured data hashing and signing.

## Data Structure

### Comment Data
```typescript
interface CommentData {
  content: string;      // The actual text content of the comment
  metadata: string;     // Additional JSON metadata for the comment
  targetUri: string;    // The URI about which the comment is being made
  parentId: bytes32;    // ID of parent comment (bytes32(0) if top-level)
  author: address;      // Address of the comment author
  appSigner: address;   // Address of the application signer
  nonce: uint256;      // Nonce for the comment
  deadline: uint256;    // Timestamp after which signatures become invalid
}
```

## Protocol Features

### Comment Posting
- `postCommentAsAuthor`: Allows users to post comments directly from their address, requiring only app-signer approval
- `postComment`: Posts comments using both author and app-signer signatures, useful for meta-transactions

### Comment Deletion
- `deleteCommentAsAuthor`: Lets authors delete their comments directly
- `deleteComment`: Deletes comments using signatures, supporting either author signature or approved app-signer signature

### App-Signer Management
- `addApprovalAsAuthor`: Directly approves an app-signer from the author's address
- `removeApprovalAsAuthor`: Directly removes an app-signer's approval from the author's address
- `addApproval`: Approves an app-signer using the author's signature
- `removeApproval`: Removes an app-signer's approval using the author's signature

Each method has corresponding hash generation functions (`getCommentId`, `getDeleteCommentHash`, `getAddApprovalHash`, `getRemoveApprovalHash`) that compute EIP-712 compliant hashes for signature verification.

## Events

The protocol emits the following events:
- `CommentAdded`: When a new comment is created
- `CommentDeleted`: When a comment is removed
- `ApprovalAdded`: When an author approves an app-signer
- `ApprovalRemoved`: When an author removes an app-signer's approval

## Security Considerations

- All operations require either direct author interaction or valid signatures
- Signatures expire after their deadline
- Nonces prevent replay attacks
- App-signer approvals can be revoked
- All signatures follow EIP-712 for secure, human-readable message signing 