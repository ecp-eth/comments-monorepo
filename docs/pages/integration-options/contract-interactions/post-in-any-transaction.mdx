# Integration Options

## Contract Interaction

### Post comment in any Ethereum transaction

In some cases, you may want to attach a comment to an Ethereum transaction. This is useful for:

- Saving gas cost by including the comment in the transaction calldata
- Adding comments to NFT mints
- Commenting on token transfers
- Adding context to any smart contract interaction

In this tutorial, we will use a locally deployed test contract with a method `yoink()`
to illustrate how to include a comment in a transaction.

The author will call the `yoink()` method on the contract,
and we will include signed and encoded comment data in the transaction's calldata.
The comment in calldata will then be indexed by our ponder indexer.

This tutorial will use `viem` for contract interaction and local block chain created with `anvil`.

::::steps

#### Test contract

Feel free to swap out the contract address and ABI used in this tutorial with any other contract and method you want to test with.

Test contract deployment is not strictly needed as the indexer will just scan all transactions with the [ECP delimiter](/sdk-reference/defaultExports/variables/COMMENT_CALLDATA_SUFFIX_DELIMITER),
and index the comment data if it finds one. So even if the test contract is not deployed, everything will still work as long
as the transaction is broadcasted to the network.

But if you feel like serious about this and want to follow along with the example, you can deploy a simple contract with a method `yoink()` to the local anvil chain:

1. Follow the steps in [Test with Anvil](/test-with-anvil) to start the anvil node.
2. Deploy [the contract](https://github.com/ecp-eth/comments-monorepo/tree/main/packages/test-protocol) to the local anvil chain:

```
forge script script/dev.s.sol:DevScript --rpc-url http://localhost:8545 --broadcast
```

#### Get the comment signature from app server

Now before we can include the comment in a transaction, we need to get it signed by the app server.
The process is similar to regular comment posting so we will reuse the simulated `AppServer` class from previous examples:

```typescript
// same as the previous example, we will get app to sign the comment data
const appSignedComment = await appServer.sign(
  authorSigner.address,
  anvil,
  content,
  targetUri
);
```

#### Encode the comment data

Next we want to encode signed comment data into hex using `encodeAbiParameters` with the ABI definition of the comment data,
luckily we have a helper function `createCommentSuffixData` to do just that:

```typescript
const commentDataSuffix = createCommentSuffixData({
  commentData: appSignedComment.commentData,
  appSignature: appSignedComment.signature,
});
```

#### Include comment in your transaction

Now you can create the test contract instance and include the encoded comment data in your transaction's data field:

```typescript
// Get test contract instance
const testContract = getContract({
  address: testContractAddress,
  abi: testContractAbi,
  client: walletClient,
});

// execute the yoink() method on the test contract, with the comment data as calldata suffix
// once the transaction is broadcasted, the comment will be indexed by the indexer
const tx = await testContract.write.yoink({
  dataSuffix: commentDataSuffix,
});
```

and wait for the transaction to be mined:

```typescript
const receipt = await waitForTransactionReceipt(walletClient, {
  hash: tx,
});
```

The comments indexer will scan transactions for valid comment data and index any comments it finds, making them available through the indexer API.

#### Testing the integration

You can verify your integration by:

1. Checking the indexer API (or [deploy indexer locally](/indexer-reference)) to see if the comment was indexed
1. Viewing the comment on your app's UI

Here's a complete example putting it all together:

```typescript
import { getContract, createWalletClient, http, parseAbi } from "viem";
import { anvil } from "viem/chains";
import { waitForTransactionReceipt } from "viem/actions";
import { createCommentSuffixData } from "@ecp.eth/sdk";
import { AppServer } from "./appServer";
import { privateKeyToAccount } from "viem/accounts";

// we use a local anvil node for this example
const transport = http("http://localhost:8545");
const testContractAddress = "0x948B3c65b89DF0B4894ABE91E6D02FE579834F8F";
const testContractAbi = parseAbi(["function yoink()"]);

/**
 * The function simulates the author who executes a transaction and post a comment as part of the transaction
 */
async function postCommentInTx(
  appServer: AppServer,
  content: string,
  targetUri: string
) {
  const authorPrivateKey =
    "0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d";
  const authorSigner = privateKeyToAccount(authorPrivateKey);
  // Create wallet client for interacting with the contract
  const walletClient = createWalletClient({
    chain: anvil,
    transport,
    account: authorSigner,
  });

  // same as the previous example, we will get app to sign the comment data
  const appSignedComment = await appServer.sign(
    authorSigner.address,
    anvil,
    content,
    targetUri
  );

  const commentDataSuffix = createCommentSuffixData({
    commentData: appSignedComment.commentData,
    appSignature: appSignedComment.signature,
  });

  // Get test contract instance
  const testContract = getContract({
    address: testContractAddress,
    abi: testContractAbi,
    client: walletClient,
  });

  // execute the yoink() method on the test contract, with the comment data as calldata suffix
  // once the transaction is broadcasted, the comment will be indexed by the indexer
  const tx = await testContract.write.yoink({
    dataSuffix: commentDataSuffix,
  });

  const receipt = await waitForTransactionReceipt(walletClient, {
    hash: tx,
  });

  return receipt;
}
```

and let's test the example:

```typescript
const server = new AppServer();

console.log("author is posting the comment...");

const receipt = await postCommentInTx(
  server,
  "Somebody successfully posted a comment in a transaction!",
  "http://localhost:3000/"
);

console.log(
  "author has posted the comment and the transaction is mined, transaction hash: ",
  receipt.transactionHash
);
```

#### Congrats! You've completed the tutorial!

::::
